<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مینی‌اپ گروه‌ها</title>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazir:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazir', Arial, sans-serif;
            text-align: center;
            direction: rtl;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .category {
            margin: 20px auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* دو ستون */
            gap: 10px; /* فاصله بین دکمه‌ها */
            justify-items: center;
            max-width: 600px; /* محدود کردن عرض کلی دکمه‌ها برای وسط‌چین شدن */
        }
        .category button {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            width: 30%; /* 30 درصد عرض ستون */
            max-width: 165px; /* 10 درصد بزرگ‌تر */
            box-sizing: border-box;
        }
        .category button:hover {
            background-color: #45a049;
        }
        .slogan {
            font-family: 'Vazir', sans-serif;
            font-size: 16px;
            color: #666;
            margin-top: 10px;
            font-weight: 700;
        }
        #travel-form, #event-form, #shop-form {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 33%; /* یک‌سوم عرض صفحه */
            margin-left: auto;
            margin-right: auto;
        }
        #travel-ads, #event-ads, #shop-ads {
            display: none;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-top: 20px;
            text-align: right;
            max-width: 33%; /* یک‌سوم عرض صفحه */
            margin-left: auto;
            margin-right: auto;
        }
        .form-group {
            margin: 10px 0;
            text-align: right;
        }
        .form-group label {
            display: block;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 90%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        #submit-travel, #submit-event, #submit-shop {
            background-color: #008CBA;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        #submit-travel:hover, #submit-event:hover, #submit-shop:hover {
            background-color: #007399;
        }
        .ad-card {
            display: inline-block;
            background-color: #fff;
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            width: 200px;
            cursor: pointer;
            text-align: right;
            vertical-align: top;
        }
        .ad-card:hover {
            background-color: #f9f9f9;
        }
        /* برای موبایل، دکمه‌ها و کارت‌ها */
        @media (max-width: 768px) {
            .category {
                grid-template-columns: 1fr; /* یک ستون در موبایل */
            }
            .category button {
                width: 50%; /* عرض دکمه در موبایل */
                max-width: 200px;
            }
            #travel-form, #event-form, #shop-form, #travel-ads, #event-ads, #shop-ads {
                max-width: 100%; /* عرض کامل در موبایل */
            }
            .ad-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>🧳 مینی‌اپ گروه‌ها</h1>
    <div class="category">
        <button onclick="showSection('event')">🫂 ایونت‌ها</button>
        <button onclick="showSection('shop')">🛍️ فروشگاه</button>
        <button onclick="showSection('travel')">🏕️ گروه‌های سفر</button>
    </div>
    <p class="slogan">دوستی‌ها از اینجا آغاز می‌شوند</p>
    <form id="travel-form">
        <h2>🏕️ ثبت آگهی گروه‌های سفر</h2>
        <div class="form-group">
            <label>ارسال تصویر:</label>
            <input type="file" id="travel-image" accept="image/*">
            <button type="button" onclick="document.getElementById('travel-image').value = ''; alert('تصویر رد شد!');">رد کردن</button>
        </div>
        <div class="form-group">
            <label>نام برگزارکننده (نام تور):</label>
            <input type="text" id="travel-organizer" placeholder="مثلاً: تور طبیعت گردی">
        </div>
        <div class="form-group">
            <label>نوع سفر:</label>
            <select id="travel-type">
                <option value="داخلی">داخلی</option>
                <option value="خارجی">خارجی</option>
            </select>
        </div>
        <div class="form-group">
            <label>نام لیدر:</label>
            <input type="text" id="travel-leader" placeholder="مثلاً: علی محمدی">
        </div>
        <div class="form-group">
            <label>وسیله سفر:</label>
            <select id="travel-vehicle">
                <option value="خودرو شخصی">خودرو شخصی</option>
                <option value="اتوبوس">اتوبوس</option>
                <option value="هواپیما">هواپیما</option>
            </select>
        </div>
        <div class="form-group">
            <label>مبدا:</label>
            <input type="text" id="travel-origin" placeholder="مثلاً: تهران">
        </div>
        <div class="form-group">
            <label>مقصد:</label>
            <input type="text" id="travel-destination" placeholder="مثلاً: شیراز">
        </div>
        <div class="form-group">
            <label>تاریخ رفت:</label>
            <input type="text" id="travel-departure" placeholder="مثلاً: 1404/03/05">
        </div>
        <div class="form-group">
            <label>تاریخ برگشت:</label>
            <input type="text" id="travel-return" placeholder="مثلاً: 1404/03/07">
        </div>
        <div class="form-group">
            <label>ظرفیت باقی‌مانده:</label>
            <input type="text" id="travel-capacity" placeholder="مثلاً: 4 نفر">
        </div>
        <div class="form-group">
            <label>هزینه:</label>
            <input type="text" id="travel-cost" placeholder="مثلاً: 1,000,000 تومان">
        </div>
        <div class="form-group">
            <label>هزینه اضافی:</label>
            <input type="text" id="travel-extra-cost" placeholder="مثلاً: 200,000 تومان">
        </div>
        <div class="form-group">
            <label>شماره کارت واریزی:</label>
            <input type="text" id="travel-card" placeholder="مثلاً: 1234-5678-9012">
        </div>
        <div class="form-group">
            <label>به نام:</label>
            <input type="text" id="travel-owner" placeholder="مثلاً: علی محمدی">
        </div>
        <div class="form-group">
            <label>تلفن هماهنگی:</label>
            <input type="text" id="travel-phone" placeholder="مثلاً: 09123456789">
        </div>
        <div class="form-group">
            <label>توضیحات بیشتر:</label>
            <textarea id="travel-description" placeholder="مثلاً: تور شامل صبحانه است..."></textarea>
        </div>
        <button type="button" id="submit-travel">✅ ثبت آگهی</button>
    </form>
    <form id="event-form">
        <h2>🫂 ثبت آگهی ایونت</h2>
        <div class="form-group">
            <label>عنوان:</label>
            <select id="event-title">
                <option value="دورهمی">دورهمی (پیاده‌روی، کافه، پارک، سینما...)</option>
                <option value="ورزش">ورزش (کوه‌پیمایی، بدمینتون، دوچرخه‌سواری...)</option>
                <option value="کمپ و سفر">کمپ و سفر (داخلی، خارجی، آبشار، دشت...)</option>
                <option value="هم‌مسیر">هم‌مسیر (شیراز به اصفهان، ونک به صادقیه...)</option>
                <option value="دیوار دوستی">دیوار دوستی (واگذاری یخچال، کتاب...)</option>
                <option value="داوطلبانه">داوطلبانه (آموزش، مشورت...)</option>
                <option value="واگذاری">واگذاری (حیوان خانگی، بلیط...)</option>
                <option value="مشاوره و راهنمایی">مشاوره و راهنمایی (پزشکی، وام...)</option>
                <option value="متفرقه">متفرقه (استخدام، کسب و کار خانگی...)</option>
            </select>
        </div>
        <div class="form-group">
            <label>تاریخ:</label>
            <input type="text" id="event-date" placeholder="مثلاً: 1404/03/05">
        </div>
        <div class="form-group">
            <label>مکان:</label>
            <input type="text" id="event-location" placeholder="مثلاً: تهران، پارک ملت">
        </div>
        <div class="form-group">
            <label>ظرفیت:</label>
            <input type="text" id="event-capacity" placeholder="مثلاً: 50 نفر">
        </div>
        <div class="form-group">
            <label>هزینه:</label>
            <input type="text" id="event-cost" placeholder="مثلاً: 500,000 تومان">
        </div>
        <button type="button" id="submit-event">✅ ثبت ایونت</button>
    </form>
    <form id="shop-form">
        <h2>🛍️ ثبت آگهی فروشگاه</h2>
        <div class="form-group">
            <label>ارسال تصویر:</label>
            <input type="file" id="shop-image" accept="image/*">
            <button type="button" onclick="document.getElementById('shop-image').value = ''; alert('تصویر رد شد!');">رد کردن</button>
        </div>
        <div class="form-group">
            <label>وضعیت محصول:</label>
            <select id="shop-status">
                <option value="نو">نو</option>
                <option value="کارکرده">کارکرده</option>
                <option value="در حد نو">در حد نو</option>
            </select>
        </div>
        <div class="form-group">
            <label>برند کالا:</label>
            <input type="text" id="shop-brand" placeholder="مثلاً: سامسونگ">
        </div>
        <div class="form-group">
            <label>مدل:</label>
            <input type="text" id="shop-model" placeholder="مثلاً: Galaxy S21">
        </div>
        <div class="form-group">
            <label>سال تولید:</label>
            <input type="text" id="shop-year" placeholder="مثلاً: 1399">
        </div>
        <div class="form-group">
            <label>قیمت:</label>
            <input type="text" id="shop-price" placeholder="مثلاً: 2,000,000 تومان">
        </div>
        <div class="form-group">
            <label>توضیحات بیشتر:</label>
            <textarea id="shop-description" placeholder="مثلاً: با گارانتی..."></textarea>
        </div>
        <button type="button" id="submit-shop">✅ ثبت محصول</button>
    </form>
    <div id="travel-ads">
        <h2>🏕️ آگهی‌های گروه‌های سفر</h2>
        <div id="travel-ads-list"></div>
    </div>
    <div id="event-ads">
        <h2>🫂 آگهی‌های ایونت‌ها</h2>
        <div id="event-ads-list"></div>
    </div>
    <div id="shop-ads">
        <h2>🛍️ آگهی‌های فروشگاه</h2>
        <div id="shop-ads-list"></div>
    </div>
    <script type="module">
        // وارد کردن توابع Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        let db;
        let isFirebaseReady = false;

        // تعریف تابع showSection قبل از استفاده
        window.showSection = function(section) {
            document.getElementById('travel-form').style.display = 'none';
            document.getElementById('event-form').style.display = 'none';
            document.getElementById('shop-form').style.display = 'none';
            document.getElementById('travel-ads').style.display = 'none';
            document.getElementById('event-ads').style.display = 'none';
            document.getElementById('shop-ads').style.display = 'none';

            if (section === 'travel') {
                document.getElementById('travel-form').style.display = 'block';
                document.getElementById('travel-ads').style.display = 'block';
                loadTravelAds();
            } else if (section === 'event') {
                document.getElementById('event-form').style.display = 'block';
                document.getElementById('event-ads').style.display = 'block';
                loadEventAds();
            } else if (section === 'shop') {
                document.getElementById('shop-form').style.display = 'block';
                document.getElementById('shop-ads').style.display = 'block';
                loadShopAds();
            }
        };

        // مقداردهی Firebase
        async function initFirebase() {
            const firebaseConfig = {
		  apiKey: "AIzaSyCfMjevdSohHrq6dJxdlrmJ0MZT5HZKZAw",
		  authDomain: "doostihagroupapp.firebaseapp.com",
		  projectId: "doostihagroupapp",
		  storageBucket: "doostihagroupapp.firebasestorage.app",
		  messagingSenderId: "746714229972",
		  appId: "1:746714229972:web:72a26758b58e2ede009f41"
            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                isFirebaseReady = true;
                console.log("Firebase initialized successfully");
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }

        // تنظیمات Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.MainButton.setText("بستن").show().onClick(() => tg.close());

        // ثبت آگهی سفر
        document.getElementById('submit-travel').addEventListener('click', async () => {
            if (!isFirebaseReady) {
                alert('اتصال به سرور قطع است! لطفاً بعداً دوباره امتحان کنید.');
                return;
            }

            const travelData = {
                organizer: document.getElementById('travel-organizer').value,
                type: document.getElementById('travel-type').value,
                leader: document.getElementById('travel-leader').value,
                vehicle: document.getElementById('travel-vehicle').value,
                origin: document.getElementById('travel-origin').value,
                destination: document.getElementById('travel-destination').value,
                departure: document.getElementById('travel-departure').value,
                return: document.getElementById('travel-return').value,
                capacity: document.getElementById('travel-capacity').value,
                cost: document.getElementById('travel-cost').value,
                extraCost: document.getElementById('travel-extra-cost').value,
                card: document.getElementById('travel-card').value,
                owner: document.getElementById('travel-owner').value,
                phone: document.getElementById('travel-phone').value,
                description: document.getElementById('travel-description').value,
                userId: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'unknown', // برای دایرکت
                timestamp: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'travels'), travelData);
                alert('آگهی سفر ثبت شد!');
                document.getElementById('travel-form').reset();
                loadTravelAds();
            } catch (error) {
                alert('خطا: ' + error.message);
                console.error('Error saving travel data:', error);
            }
        });

        // ثبت ایونت
        document.getElementById('submit-event').addEventListener('click', async () => {
            if (!isFirebaseReady) {
                alert('اتصال به سرور قطع است! لطفاً بعداً دوباره امتحان کنید.');
                return;
            }

            const eventData = {
                title: document.getElementById('event-title').value,
                date: document.getElementById('event-date').value,
                location: document.getElementById('event-location').value,
                capacity: document.getElementById('event-capacity').value,
                cost: document.getElementById('event-cost').value,
                userId: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'unknown', // برای دایرکت
                timestamp: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'events'), eventData);
                alert('ایونت ثبت شد!');
                document.getElementById('event-form').reset();
                loadEventAds();
            } catch (error) {
                alert('خطا: ' + error.message);
                console.error('Error saving event data:', error);
            }
        });

        // ثبت محصول
        document.getElementById('submit-shop').addEventListener('click', async () => {
            if (!isFirebaseReady) {
                alert('اتصال به سرور قطع است! لطفاً بعداً دوباره امتحان کنید.');
                return;
            }

            const shopData = {
                status: document.getElementById('shop-status').value,
                brand: document.getElementById('shop-brand').value,
                model: document.getElementById('shop-model').value,
                year: document.getElementById('shop-year').value,
                price: document.getElementById('shop-price').value,
                description: document.getElementById('shop-description').value,
                userId: tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 'unknown', // برای دایرکت
                timestamp: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'shop'), shopData);
                alert('محصول ثبت شد!');
                document.getElementById('shop-form').reset();
                loadShopAds();
            } catch (error) {
                alert('خطا: ' + error.message);
                console.error('Error saving shop data:', error);
            }
        });

        // بارگذاری آگهی‌های سفر
        async function loadTravelAds() {
            const travelAdsList = document.getElementById('travel-ads-list');
            travelAdsList.innerHTML = '';
            try {
                const travelsSnapshot = await getDocs(collection(db, 'travels'));
                if (travelsSnapshot.empty) {
                    travelAdsList.innerHTML = '<p>آگهی سفری یافت نشد.</p>';
                } else {
                    travelsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const adDiv = document.createElement('div');
                        adDiv.className = 'ad-card';
                        adDiv.innerHTML = `
                            <strong>تور:</strong> ${data.organizer || 'نامشخص'}<br>
                            <strong>مقصد:</strong> ${data.destination || 'نامشخص'}<br>
                            <strong>تاریخ:</strong> ${data.departure || 'نامشخص'}<br>
                            <strong>ظرفیت:</strong> ${data.capacity || 'نامشخص'}
                        `;
                        adDiv.onclick = () => {
                            if (data.userId && data.userId !== 'unknown') {
                                tg.openTelegramLink(`https://t.me/${data.userId}`);
                            } else if (data.phone) {
                                window.location.href = `https://t.me/+${data.phone}`;
                            } else {
                                alert('اطلاعات تماس موجود نیست!');
                            }
                        };
                        travelAdsList.appendChild(adDiv);
                    });
                }
            } catch (error) {
                travelAdsList.innerHTML = '<p>خطا در بارگذاری آگهی‌ها: ' + error.message + '</p>';
            }
        }

        // بارگذاری آگهی‌های ایونت
        async function loadEventAds() {
            const eventAdsList = document.getElementById('event-ads-list');
            eventAdsList.innerHTML = '';
            try {
                const eventsSnapshot = await getDocs(collection(db, 'events'));
                if (eventsSnapshot.empty) {
                    eventAdsList.innerHTML = '<p>آگهی ایونتی یافت نشد.</p>';
                } else {
                    eventsSnapshot.forEach(doc => {
                        const data = doc.data();
                        const adDiv = document.createElement('div');
                        adDiv.className = 'ad-card';
                        adDiv.innerHTML = `
                            <strong>عنوان:</strong> ${data.title || 'نامشخص'}<br>
                            <strong>تاریخ:</strong> ${data.date || 'نامشخص'}<br>
                            <strong>مکان:</strong> ${data.location || 'نامشخص'}
                        `;
                        adDiv.onclick = () => {
                            if (data.userId && data.userId !== 'unknown') {
                                tg.openTelegramLink(`https://t.me/${data.userId}`);
                            } else {
                                alert('اطلاعات تماس موجود نیست!');
                            }
                        };
                        eventAdsList.appendChild(adDiv);
                    });
                }
            } catch (error) {
                eventAdsList.innerHTML = '<p>خطا در بارگذاری آگهی‌ها: ' + error.message + '</p>';
            }
        }

        // بارگذاری آگهی‌های فروشگاه
        async function loadShopAds() {
            const shopAdsList = document.getElementById('shop-ads-list');
            shopAdsList.innerHTML = '';
            try {
                const shopSnapshot = await getDocs(collection(db, 'shop'));
                if (shopSnapshot.empty) {
                    shopAdsList.innerHTML = '<p>آگهی فروشگاهی یافت نشد.</p>';
                } else {
                    shopSnapshot.forEach(doc => {
                        const data = doc.data();
                        const adDiv = document.createElement('div');
                        adDiv.className = 'ad-card';
                        adDiv.innerHTML = `
                            <strong>برند:</strong> ${data.brand || 'نامشخص'}<br>
                            <strong>وضعیت:</strong> ${data.status || 'نامشخص'}<br>
                            <strong>قیمت:</strong> ${data.price || 'نامشخص'}
                        `;
                        adDiv.onclick = () => {
                            if (data.userId && data.userId !== 'unknown') {
                                tg.openTelegramLink(`https://t.me/${data.userId}`);
                            } else {
                                alert('اطلاعات تماس موجود نیست!');
                            }
                        };
                        shopAdsList.appendChild(adDiv);
                    });
                }
            } catch (error) {
                shopAdsList.innerHTML = '<p>خطا در بارگذاری آگهی‌ها: ' + error.message + '</p>';
            }
        }

        // مقداردهی اولیه Firebase
        initFirebase();
    </script>
</body>
</html>
