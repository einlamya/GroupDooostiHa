<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>گروه دوستی‌ها</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; direction: rtl; padding: 20px; }
    .menu { display: flex; gap: 10px; margin-bottom: 20px; }
    .menu button { padding: 5px 10px; cursor: pointer; }
    .form-container, .ad-card { display: none; padding: 10px; border: 1px solid #ccc; margin-top: 10px; }
    .form-container.active, .ad-card.active { display: block; }
    .hidden { display: none; }
    select, input, textarea { width: 100%; margin: 5px 0; }
  </style>
</head>
<body>
  <h1>🧳 گروه دوستی‌ها</h1>
  <p>دوستی‌ها از اینجا آغاز می‌شوند</p>

  <div class="menu">
    <button onclick="openForm('tour')">🫂 ایونت‌ها</button>
    <button onclick="openForm('tour')">🏕️ تورها</button>
    <button onclick="openForm('shop')">🛍️ فروشگاه</button>
  </div>

  <!-- فرم ثبت آگهی تور -->
  <div id="tourForm" class="form-container">
    <h2>🏕️ ثبت آگهی تورها</h2>
    <input type="text" id="tourOrganizer" placeholder="نام برگزارکننده (نام تور)" required>
    <select id="tourType">
      <option value="داخلی">داخلی</option>
      <option value="خارجی">خارجی</option>
    </select>
    <input type="text" id="tourLeader" placeholder="نام لیدر" required>
    <select id="tourVehicle">
      <option value="خودرو شخصی">خودرو شخصی</option>
      <option value="اتوبوس">اتوبوس</option>
      <option value="هواپیما">هواپیما</option>
      <option value="هیچ‌هایک">هیچ‌هایک</option>
      <option value="سایر">سایر</option>
    </select>
    <input type="text" id="tourOrigin" placeholder="مبدا" required>
    <input type="text" id="tourDestination" placeholder="مقصد" required>
    <input type="date" id="tourStartDate" required>
    <input type="date" id="tourEndDate" required>
    <input type="number" id="tourCapacity" placeholder="ظرفیت باقی‌مانده" required>
    <input type="number" id="tourCost" placeholder="هزینه" required>
    <input type="number" id="tourExtraCost" placeholder="هزینه اضافی">
    <input type="text" id="tourCardNumber" placeholder="شماره کارت واریزی">
    <input type="text" id="tourCardName" placeholder="به نام">
    <input type="tel" id="tourPhone" placeholder="تلفن هماهنگی" required>
    <textarea id="tourDescription" placeholder="توضیحات بیشتر"></textarea>
    <input type="file" id="tourImage" accept="image/*">
    <button onclick="submitAd('tour')">✅ ثبت آگهی</button>
    <button onclick="resetForm('tour')">🗑️ پاک کردن</button>
  </div>

  <!-- فرم ثبت آگهی ایونت -->
  <div id="eventForm" class="form-container">
    <h2>🫂 ثبت آگهی ایونت</h2>
    <select id="eventType">
      <option value="دورهمی">دورهمی (پیاده‌روی، کافه، پارک، سینما...)</option>
      <option value="ورزش">ورزش (کوه‌پیمایی، بدمینتون، دوچرخه‌سواری...)</option>
      <option value="کمپ و سفر">کمپ و سفر (داخلی، خارجی، آبشار، دشت...)</option>
      <option value="هم‌مسیر">هم‌مسیر (شیراز به اصفهان، ونک به صادقیه...)</option>
      <option value="دیوار دوستی">دیوار دوستی (واگذاری یخچال، کتاب...)</option>
      <option value="داوطلبانه">داوطلبانه (آموزش، مشورت...)</option>
      <option value="واگذاری">واگذاری (حیوان خانگی، بلیط...)</option>
      <option value="مشاوره و راهنمایی">مشاوره و راهنمایی (پزشکی، وام...)</option>
      <option value="متفرقه">متفرقه (استخدام، کسب و کار خانگی...)</option>
      <option value="سایر">سایر...</option>
    </select>
    <input type="date" id="eventStartDate" required>
    <input type="date" id="eventEndDate">
    <input type="text" id="eventLocation" placeholder="مکان" required>
    <input type="number" id="eventCapacity" placeholder="ظرفیت">
    <input type="number" id="eventCost" placeholder="هزینه">
    <textarea id="eventDescription" placeholder="توضیح بیشتر"></textarea>
    <input type="file" id="eventImage" accept="image/*">
    <button onclick="submitAd('event')">✅ ثبت ایونت</button>
    <button onclick="resetForm('event')">🗑️ پاک کردن</button>
  </div>

  <!-- فرم ثبت آگهی فروشگاه -->
  <div id="shopForm" class="form-container">
    <h2>🛍️ ثبت آگهی فروشگاه</h2>
    <select id="shopCondition">
      <option value="نو">نو</option>
      <option value="کارکرده">کارکرده</option>
      <option value="در حد نو">در حد نو</option>
    </select>
    <input type="text" id="shopBrand" placeholder="برند کالا">
    <input type="text" id="shopModel" placeholder="مدل">
    <input type="number" id="shopYear" placeholder="سال تولید">
    <input type="number" id="shopPrice" placeholder="قیمت" required>
    <textarea id="shopDescription" placeholder="توضیحات بیشتر"></textarea>
    <input type="file" id="shopImage" accept="image/*">
    <button onclick="submitAd('shop')">✅ ثبت محصول</button>
    <button onclick="resetForm('shop')">🗑️ پاک کردن</button>
  </div>

  <!-- کارت آگهی‌ها -->
  <div id="adsList" class="ad-card">
    <h2>آگهی‌های ثبت‌شده</h2>
    <div id="adsContainer"></div>
  </div>

  <script>
    // تنظیمات فایربیس
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log("Firebase initialized successfully");

    // توکن بوت تلگرام (جایگزین کنید)
    const TELEGRAM_BOT_TOKEN = "YOUR_NEW_BOT_TOKEN"; // توکن جدید از BotFather
    const TELEGRAM_CHAT_ID = "YOUR_CHAT_ID"; // چت آیدی خود را وارد کنید

    // تابع آپلود تصویر به تلگرام
    async function uploadImageToTelegram(file) {
      if (!file) return null;
      const formData = new FormData();
      formData.append("chat_id", TELEGRAM_CHAT_ID);
      formData.append("photo", file);

      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        if (!data.ok) {
          throw new Error("Telegram API error: " + data.description);
        }

        return data.result.photo[data.result.photo.length - 1].file_id;
      } catch (error) {
        console.error("Error uploading image to Telegram:", error);
        throw error;
      }
    }

    // تابع باز کردن فرم
    function openForm(type) {
      document.querySelectorAll('.form-container').forEach(form => form.classList.remove('active'));
      document.getElementById(`${type}Form`).classList.add('active');
      document.getElementById('adsList').classList.remove('active');
    }

    // تابع ریست فرم
    function resetForm(type) {
      document.getElementById(`${type}Form`).reset();
    }

    // تابع ثبت آگهی
    async function submitAd(type) {
      let formData, collectionName;
      if (type === 'tour') {
        formData = {
          organizer: document.getElementById("tourOrganizer").value,
          type: document.getElementById("tourType").value,
          leader: document.getElementById("tourLeader").value,
          vehicle: document.getElementById("tourVehicle").value,
          origin: document.getElementById("tourOrigin").value,
          destination: document.getElementById("tourDestination").value,
          startDate: document.getElementById("tourStartDate").value,
          endDate: document.getElementById("tourEndDate").value,
          capacity: document.getElementById("tourCapacity").value,
          cost: document.getElementById("tourCost").value,
          extraCost: document.getElementById("tourExtraCost").value,
          cardNumber: document.getElementById("tourCardNumber").value,
          cardName: document.getElementById("tourCardName").value,
          phone: document.getElementById("tourPhone").value,
          description: document.getElementById("tourDescription").value,
          photoId: null
        };
        collectionName = "tours";
      } else if (type === 'event') {
        formData = {
          type: document.getElementById("eventType").value,
          startDate: document.getElementById("eventStartDate").value,
          endDate: document.getElementById("eventEndDate").value,
          location: document.getElementById("eventLocation").value,
          capacity: document.getElementById("eventCapacity").value,
          cost: document.getElementById("eventCost").value,
          description: document.getElementById("eventDescription").value,
          photoId: null
        };
        collectionName = "events";
      } else if (type === 'shop') {
        formData = {
          condition: document.getElementById("shopCondition").value,
          brand: document.getElementById("shopBrand").value,
          model: document.getElementById("shopModel").value,
          year: document.getElementById("shopYear").value,
          price: document.getElementById("shopPrice").value,
          description: document.getElementById("shopDescription").value,
          photoId: null
        };
        collectionName = "shops";
      }

      try {
        // آپلود تصویر (اختیاری)
        const imageFile = document.getElementById(`${type}Image`).files[0];
        if (imageFile) {
          formData.photoId = await uploadImageToTelegram(imageFile);
        }

        // ثبت در فایربیس
        await db.collection(collectionName).add({
          ...formData,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log("آگهی با موفقیت ثبت شد");

        // ریست فرم و نمایش آگهی‌ها
        resetForm(type);
        loadAds();
      } catch (error) {
        alert("خطا در ثبت آگهی: " + error.message);
      }
    }

    // تابع بارگذاری آگهی‌ها
    function loadAds() {
      document.getElementById('adsContainer').innerHTML = '';
      ['tours', 'events', 'shops'].forEach(collection => {
        db.collection(collection).orderBy("timestamp", "desc").limit(5).get().then(querySnapshot => {
          querySnapshot.forEach(doc => {
            const ad = doc.data();
            const div = document.createElement('div');
            div.innerHTML = `<h3>${ad.title || ad.organizer || ad.condition}</h3><p>${ad.description}</p>`;
            if (ad.photoId) div.innerHTML += `<img src="https://api.telegram.org/file/bot${TELEGRAM_BOT_TOKEN}/${ad.photoId}" width="100">`;
            document.getElementById('adsContainer').appendChild(div);
          });
        });
      });
      document.querySelectorAll('.form-container').forEach(form => form.classList.remove('active'));
      document.getElementById('adsList').classList.add('active');
    }

    // تنظیمات اولیه
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
    loadAds();
  </script>
</body>
</html>
